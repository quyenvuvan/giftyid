"use client";

import React, { useState, useEffect } from "react";
import Link from "next/link";
import { 
  FaCheck, FaChevronDown, FaChevronUp, 
  FaCreditCard, FaTruck, FaGamepad, FaCogs, FaEnvelope, FaPalette,
  FaStore, FaQrcode, FaFileAlt, FaChartBar, FaComments, FaUsers,
  FaBolt, FaStar, FaGift, FaShieldAlt, FaRocket, FaHeadset, FaSync,
  FaExclamationTriangle, FaArrowLeft, FaArrowRight
} from "react-icons/fa";
import { useConfetti } from "@/hooks/useConfetti";

interface ServiceFeature {
  id: string;
  name: string;
  description: string;
  price: number;
  category: string;
  enabled: boolean;
  lastUpdated: string;
  highlight?: boolean;
  included?: boolean;
  details?: string[];
}

const basePrice = 500000; // 500.000 VNƒê - G√≥i kh·ªüi ƒëi·ªÉm

// T√≠nh nƒÉng c·ªët l√µi - hardcoded (kh√¥ng ƒë·ªïi)
const coreFeatures: ServiceFeature[] = [
  {
    id: "gian-hang",
    name: "T·∫°o v√† Qu·∫£n l√Ω Gian h√†ng",
    description: "Gian h√†ng chuy√™n nghi·ªáp tr√™n Zalo Mini App v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng",
    price: 0,
    included: true,
    category: "T√≠nh nƒÉng c·ªët l√µi",
    enabled: true,
    lastUpdated: "",
    details: [
      "Gian h√†ng chuy√™n nghi·ªáp v·ªõi giao di·ªán ƒë·∫πp",
      "Qu·∫£n l√Ω s·∫£n ph·∫©m/d·ªãch v·ª• ƒë·∫ßy ƒë·ªß",
      "H·ªá th·ªëng ƒë·∫∑t h√†ng v√† thanh to√°n",
      "Qu·∫£n l√Ω ƒë∆°n h√†ng v√† tr·∫°ng th√°i"
    ]
  },
  {
    id: "hien-thi-giftyid",
    name: "Hi·ªÉn th·ªã Gian h√†ng tr√™n GiftyID",
    description: "G·∫Øn nh√£n Shop Mall - ∆Øu ti√™n hi·ªÉn th·ªã cao nh·∫•t tr√™n GiftyID",
    price: 0,
    included: true,
    category: "T√≠nh nƒÉng c·ªët l√µi",
    enabled: true,
    lastUpdated: "",
    highlight: true,
    details: [
      "Hi·ªÉn th·ªã ∆∞u ti√™n cao nh·∫•t tr√™n GiftyID",
      "G·∫Øn nh√£n Shop Mall ƒë·ªôc quy·ªÅn",
      "Ti·∫øp c·∫≠n 75+ tri·ªáu ng∆∞·ªùi d√πng Zalo",
      "TƒÉng kh·∫£ nƒÉng hi·ªÉn th·ªã v√† t∆∞∆°ng t√°c"
    ]
  },
  {
    id: "qr-link",
    name: "Truy c·∫≠p Gian h√†ng qua QR & Link",
    description: "QR Code v√† link duy nh·∫•t cho gian h√†ng v√† s·∫£n ph·∫©m",
    price: 0,
    included: true,
    category: "T√≠nh nƒÉng c·ªët l√µi",
    enabled: true,
    lastUpdated: "",
    details: [
      "QR Code duy nh·∫•t cho gian h√†ng",
      "Link chia s·∫ª cho t·ª´ng s·∫£n ph·∫©m",
      "D·ªÖ d√†ng in ·∫•n v√† chia s·∫ª",
      "T√≠ch h·ª£p v·ªõi marketing offline"
    ]
  },
  {
    id: "form-tu-van",
    name: "Bi·ªÉu m·∫´u T∆∞∆°ng t√°c (Form)",
    description: "Form t∆∞ v·∫•n v√† kh·∫£o s√°t kh√°ch h√†ng chuy√™n nghi·ªáp",
    price: 0,
    included: true,
    category: "T√≠nh nƒÉng c·ªët l√µi",
    enabled: true,
    lastUpdated: "",
    details: [
      "Form t∆∞ v·∫•n kh√°ch h√†ng",
      "Kh·∫£o s√°t nhu c·∫ßu",
      "ƒêƒÉng k√Ω nh·∫≠n tin khuy·∫øn m√£i",
      "Thu th·∫≠p feedback kh√°ch h√†ng"
    ]
  },
  {
    id: "bao-cao",
    name: "B√°o c√°o & Th·ªëng k√™ Hi·ªáu qu·∫£",
    description: "B√°o c√°o ph√¢n t√≠ch n√¢ng cao v·ªÅ hi·ªáu qu·∫£ kinh doanh",
    price: 0,
    included: true,
    category: "T√≠nh nƒÉng c·ªët l√µi",
    enabled: true,
    lastUpdated: "",
    details: [
      "B√°o c√°o doanh thu chi ti·∫øt",
      "Th·ªëng k√™ l∆∞·ª£t truy c·∫≠p",
      "Ph√¢n t√≠ch hi·ªáu qu·∫£ CTV",
      "Dashboard qu·∫£n l√Ω real-time"
    ]
  },
  {
    id: "dien-dan",
    name: "Di·ªÖn ƒë√†n CSKH & H·ªèi ƒë√°p",
    description: "K√™nh giao ti·∫øp hai chi·ªÅu v·ªõi kh√°ch h√†ng",
    price: 0,
    included: true,
    category: "T√≠nh nƒÉng c·ªët l√µi",
    enabled: true,
    lastUpdated: "",
    details: [
      "Di·ªÖn ƒë√†n h·ªèi ƒë√°p kh√°ch h√†ng",
      "H·ªó tr·ª£ kh√°ch h√†ng 24/7",
      "X√¢y d·ª±ng c·ªông ƒë·ªìng trung th√†nh",
      "Qu·∫£n l√Ω feedback t·∫≠p trung"
    ]
  },
  {
    id: "ctv-mgm",
    name: "T√≠ch h·ª£p M·∫°ng l∆∞·ªõi CTV/MGM/Affiliate",
    description: "Ti·∫øp c·∫≠n m·∫°ng l∆∞·ªõi h√†ng trƒÉm CTV",
    price: 0,
    included: true,
    category: "T√≠nh nƒÉng c·ªët l√µi",
    enabled: true,
    lastUpdated: "",
    highlight: true,
    details: [
      "M·∫°ng l∆∞·ªõi CTV B∆∞u ƒëi·ªán",
      "Link affiliate t·ª± ƒë·ªông",
      "H·ªá th·ªëng hoa h·ªìng t·ª± ƒë·ªông",
      "Qu·∫£n l√Ω hi·ªáu qu·∫£ CTV"
    ]
  },
  {
    id: "zalo-oa",
    name: "K·∫øt n·ªëi Zalo Official Account (OA)",
    description: "ƒê·ªìng b·ªô th√¥ng tin v√† g·ª≠i tin nh·∫Øn chƒÉm s√≥c qua ZNS",
    price: 0,
    included: true,
    category: "T√≠nh nƒÉng c·ªët l√µi",
    enabled: true,
    lastUpdated: "",
    details: [
      "ƒê·ªìng b·ªô d·ªØ li·ªáu kh√°ch h√†ng",
      "G·ª≠i tin nh·∫Øn ZNS t·ª± ƒë·ªông",
      "Chi·∫øn d·ªãch marketing tr·ª±c ti·∫øp",
      "ChƒÉm s√≥c kh√°ch h√†ng t·ª± ƒë·ªông"
    ]
  },
  {
    id: "account-manager",
    name: "Account Manager chuy√™n bi·ªát 24/7",
    description: "H·ªó tr·ª£ chuy√™n bi·ªát v√† t∆∞ v·∫•n 24/7",
    price: 0,
    included: true,
    category: "T√≠nh nƒÉng c·ªët l√µi",
    enabled: true,
    lastUpdated: "",
    highlight: true,
    details: [
      "Account Manager chuy√™n bi·ªát",
      "H·ªó tr·ª£ k·ªπ thu·∫≠t 24/7",
      "T∆∞ v·∫•n chi·∫øn l∆∞·ª£c kinh doanh",
      "ƒê√†o t·∫°o v√† h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng"
    ]
  }
];

const iconMap: { [key: string]: React.ComponentType<{ className?: string }> } = {
  // T√≠nh nƒÉng c·ªët l√µi
  "gian-hang": FaStore,
  "hien-thi-giftyid": FaRocket,
  "qr-link": FaQrcode,
  "form-tu-van": FaFileAlt,
  "bao-cao": FaChartBar,
  "dien-dan": FaComments,
  "ctv-mgm": FaUsers,
  "zalo-oa": FaBolt,
  "account-manager": FaHeadset,
  
  // T√≠nh nƒÉng m·ªü r·ªông (t·ª´ Google Sheets)
  "minigame": FaGamepad,
  "flash-sale": FaGift,
  "khach-hang-than-thiet": FaStar,
  "danh-gia": FaStar,
  "vi-dien-tu": FaCreditCard,
  "van-chuyen": FaTruck,
  "crm-pos-erp": FaCogs,
  "crm-pos-erp-custom": FaCogs,
  "marketing-auto": FaEnvelope,
  "thiet-ke-giao-dien": FaPalette,
  "api-webhook": FaShieldAlt,
  "blockchain-integration": FaShieldAlt,
  "ai-chatbot": FaComments,
  "api-integration": FaShieldAlt,
};

const faqs = [
  {
    question: "T√¥i c√≥ th·ªÉ ch·ªçn t·ª´ng t√≠nh nƒÉng ri√™ng l·∫ª kh√¥ng?",
    answer: "C√≥, b·∫°n c√≥ th·ªÉ ch·ªçn b·∫•t k·ª≥ t√≠nh nƒÉng n√†o b·∫°n c·∫ßn. G√≥i c∆° b·∫£n 500.000 VNƒê ƒë√£ bao g·ªìm c√°c t√≠nh nƒÉng c·ªët l√µi, c√°c t√≠nh nƒÉng m·ªü r·ªông s·∫Ω ƒë∆∞·ª£c t√≠nh ph√≠ b·ªï sung."
  },
  {
    question: "Ph√≠ thi·∫øt l·∫≠p ban ƒë·∫ßu c√≥ bao g·ªìm kh√¥ng?",
    answer: "Ph√≠ thi·∫øt l·∫≠p ban ƒë·∫ßu l√† 5.000.000 VNƒê cho g√≥i doanh nghi·ªáp, bao g·ªìm vi·ªác c√†i ƒë·∫∑t v√† c·∫•u h√¨nh t·∫•t c·∫£ t√≠nh nƒÉng ƒë∆∞·ª£c ch·ªçn, thi·∫øt k·∫ø giao di·ªán v√† ƒë√†o t·∫°o s·ª≠ d·ª•ng."
  },
  {
    question: "Th·ªùi gian tri·ªÉn khai l√† bao l√¢u?",
    answer: "T√≠nh nƒÉng c∆° b·∫£n: 1-2 tu·∫ßn. C√°c t√≠nh nƒÉng n√¢ng cao: 2-4 tu·∫ßn t√πy theo ƒë·ªô ph·ª©c t·∫°p v√† s·ªë l∆∞·ª£ng t√≠nh nƒÉng ƒë∆∞·ª£c ch·ªçn. Account Manager s·∫Ω th√¥ng b√°o ti·∫øn ƒë·ªô chi ti·∫øt."
  },
  {
    question: "C√≥ h·ªó tr·ª£ sau khi ra m·∫Øt kh√¥ng?",
    answer: "C√≥ ƒë·∫ßy ƒë·ªß. Bao g·ªìm Account Manager chuy√™n bi·ªát, h·ªó tr·ª£ k·ªπ thu·∫≠t 24/7, c·∫≠p nh·∫≠t t√≠nh nƒÉng mi·ªÖn ph√≠ v√† t∆∞ v·∫•n ph√°t tri·ªÉn kinh doanh."
  }
];

export default function TinhPhiPage() {
  const [dynamicFeatures, setDynamicFeatures] = useState<ServiceFeature[]>([]); // Ch·ªâ ch·ª©a extension features t·ª´ Google Sheets
  const [selectedFeatures, setSelectedFeatures] = useState<string[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string>("");
  const [lastUpdated, setLastUpdated] = useState<string>("");
  const [dataSource, setDataSource] = useState<'sheets' | 'fallback' | null>(null);
  const [openFaq, setOpenFaq] = useState<number | null>(null);
  const [activeTab, setActiveTab] = useState<'core' | 'extension' | 'consultation'>('core');
  const [expandedFeatures, setExpandedFeatures] = useState<Set<string>>(new Set());
  const [customRequirements, setCustomRequirements] = useState<Record<string, string>>({});
  
  // Th√™m state cho m√¥ t·∫£ chi ti·∫øt nhu c·∫ßu c·ªßa t·∫•t c·∫£ features
  const [featureRequirements, setFeatureRequirements] = useState<Record<string, string>>({});
  
  // Th√™m state cho t√≠nh nƒÉng kh√°c
  const [otherFeatureRequirement, setOtherFeatureRequirement] = useState<string>('');
  
  // Form state - c·∫≠p nh·∫≠t theo form trang d·ªãch v·ª•
  const [formData, setFormData] = useState({
    name: '',
    phone: '',
    email: '',
    package: 'Doanh Nghi·ªáp',
    company: '',
    message: ''
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitStatus, setSubmitStatus] = useState<'idle' | 'success' | 'error'>('idle');
  const [errorMessage, setErrorMessage] = useState('');
  const [lastSubmittedData, setLastSubmittedData] = useState<typeof formData | null>(null);
  const { fireSuccessConfetti } = useConfetti();

  const fetchPricingData = async (forceRefresh = false): Promise<void> => {
    try {
      setLoading(true);
      const url = forceRefresh 
        ? '/api/service-pricing?_clearCache=true' 
        : '/api/service-pricing';
      
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.success && data.features) {
        // Ch·ªâ l·∫•y features thu·ªôc category "T√≠nh nƒÉng m·ªü r·ªông"
        const extensionFeatures: ServiceFeature[] = data.features
          .filter((f: { category: string }) => f.category === 'T√≠nh nƒÉng m·ªü r·ªông')
          .map((f: { id: string; name: string; description: string; price: number; category: string; enabled: boolean; lastUpdated: string; highlight?: boolean; included?: boolean; details?: string[] }) => {
            // T·∫°o details chi ti·∫øt d·ª±a tr√™n feature id
            let details = [];
            switch(f.id) {
              case 'crm-pos-erp-custom':
                details = [
                  'T√≠ch h·ª£p v·ªõi h·ªá th·ªëng CRM hi·ªán t·∫°i',
                  'ƒê·ªìng b·ªô d·ªØ li·ªáu POS real-time', 
                  'K·∫øt n·ªëi ERP doanh nghi·ªáp',
                  'T√πy ch·ªânh theo quy tr√¨nh ri√™ng'
                ];
                break;
              case 'blockchain-integration':
                details = [
                  'Marketplace NFT t√πy ch·ªânh',
                  'Smart contract t·ª± ƒë·ªông',
                  'V√≠ blockchain t√≠ch h·ª£p',
                  'B·∫£o m·∫≠t ƒëa l·ªõp blockchain'
                ];
                break;
              case 'ai-chatbot':
                details = [
                  'AI tr·∫£ l·ªùi t·ª± ƒë·ªông 24/7',
                  'H·ªçc t·ª´ d·ªØ li·ªáu kh√°ch h√†ng',
                  'T√≠ch h·ª£p v·ªõi Zalo OA',
                  'Dashboard qu·∫£n l√Ω h·ªôi tho·∫°i'
                ];
                break;
              case 'api-integration':
                details = [
                  'T√≠ch h·ª£p API b√™n th·ª© 3',
                  'Webhook t·ª± ƒë·ªông',
                  'Data mapping linh ho·∫°t',
                  'Monitoring v√† logging'
                ];
                break;
              default:
                details = f.details || [
                  `T√≠nh nƒÉng ${f.name}`,
                  'H·ªó tr·ª£ chuy√™n bi·ªát 24/7', 
                  'T√πy ch·ªânh theo nhu c·∫ßu',
                  'ƒê√†o t·∫°o s·ª≠ d·ª•ng chi ti·∫øt'
                ];
            }
            
            return {
              ...f,
              icon: iconMap[f.id] || FaCogs,
              details,
              highlight: f.highlight || false,
              included: f.included || false
            };
          });
        setDynamicFeatures(extensionFeatures);
        setLastUpdated(new Date(data.timestamp).toLocaleString('vi-VN'));
        setDataSource(data.source || 'sheets');
        setError("");
      } else {
        setDynamicFeatures([]);
        setDataSource('fallback');
        setError("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t√≠nh nƒÉng m·ªü r·ªông t·ª´ Google Sheets");
      }
    } catch (error) {
      console.error('Error fetching extension features:', error);
      setError("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t√≠nh nƒÉng m·ªü r·ªông t·ª´ Google Sheets.");
      setDynamicFeatures([]);
      setDataSource('fallback');
    } finally {
      setLoading(false);
    }
  };

  const getAllFeatures = (): ServiceFeature[] => {
    return [...coreFeatures, ...dynamicFeatures]; // K·∫øt h·ª£p hardcoded + Google Sheets
  };

  const getCoreFeatures = (): ServiceFeature[] => {
    return coreFeatures; // S·ª≠ d·ª•ng hardcoded coreFeatures
  };

  const getExtensionFeatures = (): ServiceFeature[] => {
    return dynamicFeatures; // dynamicFeatures ch·ªâ ch·ª©a extension features t·ª´ Google Sheets
  };

  const calculateTotal = () => {
    const allFeatures = getAllFeatures();
    const selectedServices = selectedFeatures
      .map(id => allFeatures.find(f => f.id === id))
      .filter((f): f is ServiceFeature => !!f);
    
    const monthlyTotal = basePrice + selectedServices
      .filter(f => !f.included)
      .reduce((sum, f) => sum + (f.price || 0), 0);
    
    const setupFee = 5000000; // 5 tri·ªáu VNƒê
    const totalFirstMonth = monthlyTotal + setupFee;
    const annualTotal = monthlyTotal * 12;
    const annualSavings = Math.floor(annualTotal * 0.1);

    return {
      monthlyTotal,
      setupFee,
      totalFirstMonth,
      selectedServices,
      annualTotal,
      annualSavings
    };
  };

  const toggleFeature = (featureId: string): void => {
    setSelectedFeatures(prev =>
      prev.includes(featureId)
        ? prev.filter(id => id !== featureId)
        : [...prev, featureId]
    );
  };

  const toggleFaq = (index: number): void => {
    setOpenFaq(openFaq === index ? null : index);
  };

  const toggleFeatureExpansion = (featureId: string): void => {
    setExpandedFeatures(prev => {
      const newSet = new Set(prev);
      if (newSet.has(featureId)) {
        newSet.delete(featureId);
      } else {
        newSet.add(featureId);
      }
      return newSet;
    });
  };

  const handleCustomRequirementChange = (featureId: string, requirement: string): void => {
    setCustomRequirements(prev => ({
      ...prev,
      [featureId]: requirement
    }));
  };

  // Handler cho m√¥ t·∫£ chi ti·∫øt nhu c·∫ßu c·ªßa t·∫•t c·∫£ features
  const handleFeatureRequirementChange = (featureId: string, requirement: string): void => {
    setFeatureRequirements(prev => ({
      ...prev,
      [featureId]: requirement
    }));
  };

  // Handler cho t√≠nh nƒÉng kh√°c
  const handleOtherFeatureRequirementChange = (requirement: string): void => {
    setOtherFeatureRequirement(requirement);
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>): void => {
    const { name, value } = e.target;
    
    // X·ª≠ l√Ω phone validation nh∆∞ trang d·ªãch v·ª•
    let processedValue = value;
    if (name === 'phone') {
      processedValue = value.replace(/[^0-9\s\-().]/g, '');
    }
    
    setFormData(prev => ({
      ...prev,
      [name]: processedValue
    }));
    
    if (submitStatus !== 'idle') {
      setSubmitStatus('idle');
      setErrorMessage('');
    }
  };

  const handleSubmit = async (e: React.FormEvent): Promise<void> => {
    e.preventDefault();
    
    if (!formData.name || !formData.phone || !formData.email) {
      setSubmitStatus('error');
      setErrorMessage('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
      return;
    }

    // Ki·ªÉm tra m√¥ t·∫£ chi ti·∫øt nhu c·∫ßu b·∫Øt bu·ªôc cho c√°c features kh√¥ng c√≥ hasCustomPrice
    const selectedExtensionFeatures = getExtensionFeatures().filter(f => selectedFeatures.includes(f.id));
    const missingRequiredDescriptions = selectedExtensionFeatures.filter(f => 
      f.price > 0 && (!featureRequirements[f.id] || featureRequirements[f.id].trim() === '')
    );

    if (missingRequiredDescriptions.length > 0) {
      setSubmitStatus('error');
      setErrorMessage(`Vui l√≤ng ƒëi·ªÅn m√¥ t·∫£ chi ti·∫øt nhu c·∫ßu cho: ${missingRequiredDescriptions.map(f => f.name).join(', ')}`);
      return;
    }

    setIsSubmitting(true);
    setSubmitStatus('idle');

    try {
      // Chu·∫©n b·ªã th√¥ng tin chi ti·∫øt cho email
      const { totalFirstMonth, monthlyTotal, setupFee } = calculateTotal();
      const selectedFeatureDetails = getExtensionFeatures()
        .filter(f => selectedFeatures.includes(f.id))
        .map(f => ({ 
          name: f.name, 
          price: f.price, 
          description: f.description,
          customRequirement: customRequirements[f.id] || null,
          featureRequirement: featureRequirements[f.id] || null,
          hasCustomPrice: f.price === 0
        }));

      // Th√™m th√¥ng tin v·ªÅ core features c√≥ m√¥ t·∫£ nhu c·∫ßu
      const coreFeatureDetails = getCoreFeatures()
        .filter(f => featureRequirements[f.id])
        .map(f => ({
          name: f.name,
          description: f.description,
          featureRequirement: featureRequirements[f.id]
        }));
      
      const emailContent = {
        // Th√¥ng tin kh√°ch h√†ng
        customerInfo: {
          name: formData.name,
          phone: formData.phone,
          email: formData.email,
          company: formData.company || 'Kh√¥ng cung c·∫•p',
          package: formData.package,
          message: formData.message || 'Kh√¥ng c√≥ nhu c·∫ßu c·ª• th·ªÉ'
        },
        
        // Th√¥ng tin g√≥i ƒë√£ ch·ªçn
        packageInfo: {
          basePackage: 'G√≥i Doanh Nghi·ªáp',
          basePrice: 500000,
          coreFeatureCount: coreFeaturesList.length,
          selectedExtensions: selectedFeatureDetails,
          extensionCount: selectedFeatureDetails.length
        },
        
        // Chi ti·∫øt t√†i ch√≠nh
        pricing: {
          monthlyFee: monthlyTotal,
          setupFee: setupFee,
          totalFirstMonth: totalFirstMonth,
          annualDiscount: Math.round(monthlyTotal * 12 * 0.1)
        },
        
        // Y√™u c·∫ßu t√πy ch·ªânh
        customRequirements: customRequirements,
        
        // M√¥ t·∫£ chi ti·∫øt nhu c·∫ßu cho t·∫•t c·∫£ features
        featureRequirements: featureRequirements,
        coreFeatureDetails: coreFeatureDetails,
        
        // T√≠nh nƒÉng kh√°c
        otherFeatureRequirement: otherFeatureRequirement || null,
        
        // Metadata
        timestamp: new Date().toISOString(),
        source: 'Trang t√≠nh ph√≠ t√πy ch·ªânh'
      };

      const response = await fetch('/api/consultation', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(emailContent),
      });

      if (response.ok) {
        setSubmitStatus('success');
        setLastSubmittedData(formData);
        setFormData({
          name: '',
          phone: '',
          email: '',
          package: 'Doanh Nghi·ªáp',
          company: '',
          message: ''
        });
        setCustomRequirements({});
        setFeatureRequirements({});
        setOtherFeatureRequirement('');
        fireSuccessConfetti();
        
        // Auto hide success message after 10 seconds
        setTimeout(() => {
          setSubmitStatus('idle');
          setLastSubmittedData(null);
        }, 10000);
      } else {
        throw new Error('G·ª≠i th√¥ng tin th·∫•t b·∫°i');
      }
    } catch (err) {
      console.error('Submit error:', err);
      setSubmitStatus('error');
      setErrorMessage('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i sau');
    } finally {
      setIsSubmitting(false);
    }
  };

  useEffect(() => {
    fetchPricingData();
  }, []);

  const { monthlyTotal, setupFee, totalFirstMonth, selectedServices, annualTotal, annualSavings } = calculateTotal();
  const coreFeaturesList = getCoreFeatures();
  const extensionFeatures = getExtensionFeatures();

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Mobile Header */}
      <div className="bg-white shadow-sm sticky top-0 z-10">
        <div className="px-4 py-3">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <Link 
                href="/dich-vu"
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <FaArrowLeft className="w-5 h-5 text-gray-600" />
              </Link>
              <div>
                <h1 className="text-lg sm:text-xl font-bold text-gray-900">
                  T√≠nh ph√≠ Doanh nghi·ªáp
                </h1>
                <p className="text-xs sm:text-sm text-gray-600">
                  T√πy ch·ªânh theo nhu c·∫ßu
                </p>
              </div>
            </div>
            
            <div className="flex space-x-2">
              <button
                onClick={() => fetchPricingData(true)}
                disabled={loading}
                className="p-2 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors disabled:opacity-50"
              >
                <FaSync className={`w-4 h-4 text-blue-600 ${loading ? 'animate-spin' : ''}`} />
              </button>

            </div>
          </div>
          
          {/* Progress Stepper */}
          <div className="mt-3 mx-2">
            <div className="flex items-center justify-between mb-2">
              {/* Step 1 */}
              <div className="flex items-center space-x-1">
                <div className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-medium ${
                  activeTab === 'core' 
                    ? 'bg-blue-600 text-white' 
                    : (activeTab === 'extension' || activeTab === 'consultation') ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-500'
                }`}>
                  1
                </div>
                <span className={`text-xs font-medium ${
                  activeTab === 'core' ? 'text-blue-600' : (activeTab === 'extension' || activeTab === 'consultation') ? 'text-green-600' : 'text-gray-500'
                }`}>
                  C·ªët l√µi
                </span>
              </div>
              
              {/* Line 1 */}
              <div className={`flex-1 h-0.5 mx-1 ${
                activeTab === 'extension' || activeTab === 'consultation' ? 'bg-green-500' : 'bg-gray-300'
              }`}></div>
              
              {/* Step 2 */}
              <div className="flex items-center space-x-1">
                <div className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-medium ${
                  activeTab === 'extension'
                    ? 'bg-blue-600 text-white'
                    : activeTab === 'consultation' ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-500'
                }`}>
                  2
                </div>
                <span className={`text-xs font-medium ${
                  activeTab === 'extension' ? 'text-blue-600' : activeTab === 'consultation' ? 'text-green-600' : 'text-gray-500'
                }`}>
                  M·ªü r·ªông
                </span>
              </div>
              
              {/* Line 2 */}
              <div className={`flex-1 h-0.5 mx-1 ${
                activeTab === 'consultation' ? 'bg-green-500' : 'bg-gray-300'
              }`}></div>
              
              {/* Step 3 */}
              <div className="flex items-center space-x-1">
                <div className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-medium ${
                  activeTab === 'consultation'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-300 text-gray-500'
                }`}>
                  3
                </div>
                <span className={`text-xs font-medium ${
                  activeTab === 'consultation' ? 'text-blue-600' : 'text-gray-500'
                }`}>
                  T∆∞ v·∫•n
                </span>
              </div>
            </div>
          </div>
          
          {lastUpdated && (
            <div className="text-xs text-gray-500 mt-2 space-y-1">
              <p>Gi√° c·∫≠p nh·∫≠t: {lastUpdated}</p>
              {dataSource && (
                <p className="flex items-center space-x-1">
                  {dataSource === 'sheets' ? (
                    <>
                      <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                      <span>T√≠nh nƒÉng m·ªü r·ªông t·ª´ Google Sheets</span>
                    </>
                  ) : (
                    <>
                      <span className="w-2 h-2 bg-orange-500 rounded-full"></span>
                      <span>Google Sheets kh√¥ng kh·∫£ d·ª•ng (t√≠nh nƒÉng m·ªü r·ªông tr·ªëng)</span>
                    </>
                  )}
                </p>
              )}
            </div>
          )}
        </div>
      </div>

      <div className="px-4 py-6 max-w-6xl mx-auto">
        <div className="flex flex-col lg:flex-row gap-6">
          {/* Main Content */}
          <div className="flex-1">
            <div className="space-y-6">
              {/* Error Alert */}
              {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <div className="flex items-start space-x-3">
                    <FaExclamationTriangle className="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0" />
                    <div>
                      <h3 className="text-sm font-medium text-red-800">C√≥ l·ªói x·∫£y ra</h3>
                      <p className="text-sm text-red-700 mt-1">{error}</p>
                    </div>
                  </div>
                </div>
              )}

              {loading ? (
                <div className="flex justify-center items-center py-12">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                  <span className="ml-3 text-gray-600">ƒêang t·∫£i...</span>
                </div>
              ) : (
                <>
                  {/* Step Content */}
                  {activeTab === 'core' && (
                    /* B∆∞·ªõc 1: T√≠nh nƒÉng c·ªët l√µi */
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200">
                      <div className="p-4 border-b border-gray-100">
                        <div className="flex items-center space-x-3">
                          <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <span className="text-blue-600 font-bold text-lg">1</span>
                          </div>
                          <div>
                            <h2 className="text-lg font-semibold text-gray-900">
                              üîπ T√≠nh nƒÉng c·ªët l√µi
                            </h2>
                            <p className="text-sm text-gray-600">
                              ƒê√£ bao g·ªìm trong g√≥i c∆° b·∫£n 500.000 VNƒê/th√°ng (Nh·∫•n ƒë·ªÉ xem chi ti·∫øt)
                            </p>
                          </div>
                        </div>
                      </div>
                      <div className="divide-y divide-gray-100">
                        {coreFeaturesList.map((feature: ServiceFeature) => {
                          const isExpanded = expandedFeatures.has(feature.id);
                          
                          return (
                            <div key={feature.id} className="p-4">
                              <button
                                onClick={() => toggleFeatureExpansion(feature.id)}
                                className="w-full text-left hover:bg-gray-50 rounded-lg transition-colors p-2 -m-2"
                              >
                                <div className="flex items-center justify-between">
                                  <div className="flex items-center space-x-3">
                                    <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                      {(() => {
                                        const IconComponent = iconMap[feature.id] || FaCheck;
                                        return <IconComponent className="w-5 h-5 text-green-600" />;
                                      })()}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                      <h3 className="font-medium text-gray-900 text-sm sm:text-base text-left">
                                        {feature.name}
                                      </h3>
                                      <p className="text-xs sm:text-sm text-gray-600 mt-1 text-left">
                                        {feature.description}
                                      </p>
                                    </div>
                                  </div>
                                  <div className="flex items-center space-x-2 ml-4">
                                    <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                                      ‚úì Bao g·ªìm
                                    </span>
                                    {isExpanded ? (
                                      <FaChevronUp className="w-4 h-4 text-gray-500" />
                                    ) : (
                                      <FaChevronDown className="w-4 h-4 text-gray-500" />
                                    )}
                                  </div>
                                </div>
                              </button>
                              
                              {isExpanded && (
                                <div className="mt-4 ml-13 pl-4 border-l-2 border-green-200 animate-in slide-in-from-top-2 duration-200">
                                  <h4 className="font-medium text-gray-900 text-sm mb-2">Chi ti·∫øt t√≠nh nƒÉng:</h4>
                                  <ul className="space-y-2 mb-4">
                                    {(feature.details || []).map((detail: string, index: number) => (
                                      <li key={index} className="flex items-start text-xs sm:text-sm text-gray-700">
                                        <FaCheck className="w-3 h-3 text-green-500 mr-2 mt-1 flex-shrink-0" />
                                        <span>{detail}</span>
                                      </li>
                                    ))}
                                  </ul>
                                  
                                  {/* Tr∆∞·ªùng m√¥ t·∫£ chi ti·∫øt nhu c·∫ßu cho core features */}
                                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <label className="block text-xs font-medium text-blue-800 mb-2">
                                      üí° M√¥ t·∫£ chi ti·∫øt nhu c·∫ßu c·ªßa b·∫°n (t√πy ch·ªçn):
                                    </label>
                                    <textarea
                                      value={featureRequirements[feature.id] || ''}
                                      onChange={(e) => handleFeatureRequirementChange(feature.id, e.target.value)}
                                      placeholder={`VD: C·∫ßn t√πy ch·ªânh ${feature.name} theo c√°ch...`}
                                      className="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs resize-none"
                                      rows={2}
                                    />
                                    <p className="text-xs text-blue-700 mt-1">
                                      M√¥ t·∫£ chi ti·∫øt s·∫Ω gi√∫p ch√∫ng t√¥i t∆∞ v·∫•n v√† tri·ªÉn khai t·ªët h∆°n
                                    </p>
                                  </div>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                      
                      {/* Next Button */}
                      <div className="p-4 border-t border-gray-100 bg-gray-50">
                        <div className="flex justify-between items-center">
                          <div className="text-sm text-gray-600">
                            B∆∞·ªõc 1/3: T√≠nh nƒÉng c·ªët l√µi
                          </div>
                          <button
                            onClick={() => setActiveTab('extension')}
                            className="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors font-medium"
                          >
                            <span>Ti·∫øp theo</span>
                            <FaArrowRight className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {activeTab === 'extension' && (
                    /* B∆∞·ªõc 2: T√≠nh nƒÉng m·ªü r·ªông */
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200">
                      <div className="p-4 border-b border-gray-100">
                        <div className="flex items-center space-x-3">
                          <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <span className="text-blue-600 font-bold text-lg">2</span>
                          </div>
                          <div>
                            <h2 className="text-lg font-semibold text-gray-900">
                              ‚ö° T√≠nh nƒÉng m·ªü r·ªông
                            </h2>
                            <p className="text-sm text-gray-600">
                              Ch·ªçn t√≠nh nƒÉng b·ªï sung theo nhu c·∫ßu ({selectedFeatures.length} ƒë√£ ch·ªçn)
                            </p>
                          </div>
                        </div>
                      </div>
                      
                      <div className="divide-y divide-gray-100">
                        {extensionFeatures.length === 0 ? (
                          <div className="p-8 text-center">
                            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                              <FaSync className="w-8 h-8 text-gray-400" />
                            </div>
                            <h3 className="text-lg font-medium text-gray-900 mb-2">
                              ƒêang t·∫£i t√≠nh nƒÉng m·ªü r·ªông
                            </h3>
                            <p className="text-sm text-gray-600 mb-4">
                              T√≠nh nƒÉng m·ªü r·ªông t·ª´ Google Sheets ƒëang ƒë∆∞·ª£c t·∫£i...
                            </p>
                            <button
                              onClick={() => fetchPricingData(true)}
                              disabled={loading}
                              className="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors"
                            >
                              <FaSync className={`w-4 h-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
                              T·∫£i l·∫°i
                            </button>
                          </div>
                        ) : (
                          extensionFeatures.map((feature) => {
                          const isSelected = selectedFeatures.includes(feature.id);
                          const hasCustomPrice = feature.price === 0; // Kh√¥ng c√≥ gi√° c·ª• th·ªÉ
                          
                          return (
                            <div key={feature.id} className="p-4 hover:bg-gray-50 transition-colors">
                              <div className="flex items-start space-x-3">
                                <div className={`w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 transition-colors ${
                                  isSelected 
                                    ? 'bg-blue-100 text-blue-600' 
                                    : 'bg-gray-100 text-gray-400'
                                }`}>
                                  {(() => {
                                    const IconComponent = iconMap[feature.id] || FaCogs;
                                    return <IconComponent className="w-5 h-5" />;
                                  })()}
                                </div>
                                
                                <div className="flex-1 min-w-0">
                                  <div className="flex items-start justify-between">
                                    <div className="flex-1">
                                      <h3 className="font-medium text-gray-900 text-sm sm:text-base">
                                        {feature.name}
                                      </h3>
                                      <p className="text-xs sm:text-sm text-gray-600 mt-1 leading-relaxed">
                                        {feature.description}
                                      </p>
                                      
                                      {isSelected && (
                                        <div className="mt-3 animate-in slide-in-from-top-2 duration-200">
                                          <ul className="space-y-1 mb-3">
                                            {(feature.details || []).map((detail: string, index: number) => (
                                              <li key={index} className="flex items-start text-xs text-gray-700">
                                                <FaCheck className="w-3 h-3 text-green-500 mr-2 mt-0.5 flex-shrink-0" />
                                                <span>{detail}</span>
                                              </li>
                                            ))}
                                          </ul>
                                          
                                          {/* Tr∆∞·ªùng m√¥ t·∫£ chi ti·∫øt nhu c·∫ßu cho t·∫•t c·∫£ extension features */}
                                          <div className={`border rounded-lg p-3 mb-3 ${hasCustomPrice ? 'bg-yellow-50 border-yellow-200' : 'bg-blue-50 border-blue-200'}`}>
                                            <label className={`block text-xs font-medium mb-2 ${hasCustomPrice ? 'text-yellow-800' : 'text-blue-800'}`}>
                                              üí° M√¥ t·∫£ chi ti·∫øt nhu c·∫ßu c·ªßa b·∫°n {hasCustomPrice ? '' : '(b·∫Øt bu·ªôc)'}:
                                            </label>
                                            <textarea
                                              value={featureRequirements[feature.id] || ''}
                                              onChange={(e) => handleFeatureRequirementChange(feature.id, e.target.value)}
                                              placeholder={`VD: C·∫ßn ${feature.name} ƒë·ªÉ...`}
                                              className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 text-xs resize-none ${
                                                hasCustomPrice 
                                                  ? 'border-yellow-300 focus:ring-yellow-500' 
                                                  : 'border-blue-300 focus:ring-blue-500'
                                              }`}
                                              rows={2}
                                              required={!hasCustomPrice}
                                            />
                                            <p className={`text-xs mt-1 ${hasCustomPrice ? 'text-yellow-700' : 'text-blue-700'}`}>
                                              {hasCustomPrice 
                                                ? 'Th√¥ng tin n√†y s·∫Ω ƒë∆∞·ª£c g·ª≠i cho team ƒë·ªÉ b√°o gi√° ch√≠nh x√°c'
                                                : 'M√¥ t·∫£ chi ti·∫øt gi√∫p ch√∫ng t√¥i hi·ªÉu r√µ nhu c·∫ßu v√† tri·ªÉn khai t·ªët h∆°n'
                                              }
                                            </p>
                                          </div>

                                          {/* Input cho y√™u c·∫ßu t√πy ch·ªânh b·ªï sung n·∫øu kh√¥ng c√≥ gi√° c·ª• th·ªÉ */}
                                          {hasCustomPrice && (
                                            <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                              <label className="block text-xs font-medium text-orange-800 mb-2">
                                                üîß Y√™u c·∫ßu t√πy ch·ªânh b·ªï sung (t√πy ch·ªçn):
                                              </label>
                                              <textarea
                                                value={customRequirements[feature.id] || ''}
                                                onChange={(e) => handleCustomRequirementChange(feature.id, e.target.value)}
                                                placeholder={`VD: T√≠ch h·ª£p v·ªõi h·ªá th·ªëng ABC, giao di·ªán theo brand ri√™ng...`}
                                                className="w-full px-3 py-2 border border-orange-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-xs resize-none"
                                                rows={2}
                                              />
                                              <p className="text-xs text-orange-700 mt-1">
                                                Y√™u c·∫ßu k·ªπ thu·∫≠t ƒë·∫∑c bi·ªát ho·∫∑c t√πy ch·ªânh n√¢ng cao
                                              </p>
                                            </div>
                                          )}
                                        </div>
                                      )}
                                    </div>
                                    
                                    <div className="ml-4 text-right">
                                      <div className="text-right mb-2">
                                        {hasCustomPrice ? (
                                          <div className="font-bold text-orange-600 text-sm">
                                            T√πy ch·ªânh
                                          </div>
                                        ) : (
                                          <>
                                            <div className="font-bold text-gray-900 text-sm sm:text-base">
                                              +{feature.price.toLocaleString('vi-VN')}
                                            </div>
                                            <div className="text-xs text-gray-500">VNƒê/th√°ng</div>
                                          </>
                                        )}
                                      </div>
                                      <button
                                        onClick={() => toggleFeature(feature.id)}
                                        className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all transform hover:scale-105 ${
                                          isSelected
                                            ? hasCustomPrice 
                                              ? 'bg-orange-600 text-white hover:bg-orange-700 shadow-md'
                                              : 'bg-blue-600 text-white hover:bg-blue-700 shadow-md'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                      >
                                        {isSelected ? (
                                          <>
                                            <FaCheck className="inline w-3 h-3 mr-1" />
                                            {hasCustomPrice ? 'Quan t√¢m' : 'ƒê√£ ch·ªçn'}
                                          </>
                                        ) : (
                                          hasCustomPrice ? 'Quan t√¢m' : 'Ch·ªçn'
                                        )}
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                        
                        {/* M·ª•c t√≠nh nƒÉng kh√°c */}
                        <div className="p-4 border-t border-gray-100 bg-purple-50">
                          <div className="flex items-start space-x-3">
                            <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                              <FaCogs className="w-5 h-5 text-purple-600" />
                            </div>
                            
                            <div className="flex-1 min-w-0">
                              <h3 className="font-medium text-gray-900 text-sm sm:text-base mb-2">
                                üéØ T√≠nh nƒÉng kh√°c
                              </h3>
                              <p className="text-xs sm:text-sm text-gray-600 mb-3">
                                M√¥ t·∫£ chi ti·∫øt nhu c·∫ßu ngo√†i nh·ªØng t√≠nh nƒÉng m·ªü r·ªông hi·ªán c√≥
                              </p>
                              
                              <div className="bg-white border border-purple-200 rounded-lg p-3">
                                <label className="block text-xs font-medium text-purple-800 mb-2">
                                  üí° M√¥ t·∫£ chi ti·∫øt t√≠nh nƒÉng b·∫°n c·∫ßn:
                                </label>
                                <textarea
                                  value={otherFeatureRequirement}
                                  onChange={(e) => handleOtherFeatureRequirementChange(e.target.value)}
                                  placeholder="VD: C·∫ßn t√≠ch h·ª£p v·ªõi h·ªá th·ªëng qu·∫£n l√Ω kho, API thanh to√°n ƒë·∫∑c bi·ªát, b√°o c√°o t√πy ch·ªânh..."
                                  className="w-full px-3 py-2 border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs resize-none"
                                  rows={3}
                                />
                                <p className="text-xs text-purple-700 mt-1">
                                  M√¥ t·∫£ c√†ng chi ti·∫øt c√†ng gi√∫p ch√∫ng t√¥i t∆∞ v·∫•n v√† b√°o gi√° ch√≠nh x√°c h∆°n
                                </p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                                             {/* Navigation Buttons */}
                       <div className="p-4 border-t border-gray-100 bg-gray-50">
                         <div className="flex justify-between items-center">
                           <button
                             onClick={() => setActiveTab('core')}
                             className="flex items-center space-x-2 text-gray-600 hover:text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors font-medium"
                           >
                             <FaArrowLeft className="w-4 h-4" />
                             <span>Quay l·∫°i</span>
                           </button>
                           
                           <div className="text-sm text-gray-600">
                             B∆∞·ªõc 2/3: T√≠nh nƒÉng m·ªü r·ªông
                           </div>
                           
                           <button
                             onClick={() => setActiveTab('consultation')}
                             className="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors font-medium"
                           >
                             <span>Ti·∫øp theo</span>
                             <FaArrowRight className="w-4 h-4" />
                           </button>
                         </div>
                       </div>
                    </div>
                  )}

                  {activeTab === 'consultation' && (
                    /* B∆∞·ªõc 3: ƒêƒÉng k√Ω t∆∞ v·∫•n v√† FAQ */
                    <div className="space-y-6">
                      {/* Form ƒëƒÉng k√Ω t∆∞ v·∫•n */}
                      <div className="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div className="p-4 border-b border-gray-100">
                          <div className="flex items-center space-x-3">
                            <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                              <span className="text-blue-600 font-bold text-lg">3</span>
                            </div>
                            <div>
                              <h2 className="text-lg font-semibold text-gray-900">
                                üìû ƒêƒÉng k√Ω t∆∞ v·∫•n mi·ªÖn ph√≠
                              </h2>
                              <p className="text-sm text-gray-600">
                                Li√™n h·ªá ƒë·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n chi ti·∫øt v√† b√°o gi√° ch√≠nh x√°c
                              </p>
                            </div>
                          </div>
                        </div>
                        
                        <div className="p-4">
                          {/* Th√¥ng tin ƒë√£ ch·ªçn */}
                          <div className="bg-blue-50 rounded-lg p-4 mb-4">
                            <h3 className="font-medium text-blue-900 mb-2">üìã Th√¥ng tin g√≥i ƒë√£ ch·ªçn:</h3>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span>G√≥i c∆° b·∫£n:</span>
                                <span className="font-medium">500.000 VNƒê/th√°ng</span>
                              </div>
                              <div className="text-xs text-blue-700">
                                ‚úì Bao g·ªìm {coreFeaturesList.length} t√≠nh nƒÉng c·ªët l√µi
                              </div>
                              {selectedFeatures.length > 0 && (
                                <>
                                  <div className="border-t border-blue-200 pt-2">
                                    <div className="font-medium mb-2">T√≠nh nƒÉng m·ªü r·ªông ƒë√£ ch·ªçn:</div>
                                    {extensionFeatures.filter(f => selectedFeatures.includes(f.id)).map(feature => (
                                      <div key={feature.id} className="mb-2">
                                        <div className="flex justify-between text-xs">
                                          <span>‚Ä¢ {feature.name}</span>
                                          <span>
                                            {feature.price > 0 
                                              ? `+${feature.price.toLocaleString('vi-VN')} VNƒê` 
                                              : 'B√°o gi√° ri√™ng'
                                            }
                                          </span>
                                        </div>
                                        {/* Hi·ªÉn th·ªã m√¥ t·∫£ chi ti·∫øt nhu c·∫ßu n·∫øu c√≥ */}
                                        {featureRequirements[feature.id] && (
                                          <div className="text-xs text-blue-600 mt-1 pl-2 border-l-2 border-blue-300">
                                            <strong>Nhu c·∫ßu:</strong> &quot;{featureRequirements[feature.id]}&quot;
                                          </div>
                                        )}
                                        {/* Hi·ªÉn th·ªã y√™u c·∫ßu t√πy ch·ªânh n·∫øu c√≥ */}
                                        {customRequirements[feature.id] && (
                                          <div className="text-xs text-orange-600 mt-1 pl-2 border-l-2 border-orange-300 italic">
                                            <strong>T√πy ch·ªânh:</strong> &quot;{customRequirements[feature.id]}&quot;
                                          </div>
                                        )}
                                      </div>
                                    ))}
                                  </div>
                                  <div className="border-t border-blue-200 pt-2 flex justify-between font-medium">
                                    <span>T·ªïng th√°ng ƒë·∫ßu:</span>
                                    <span className="text-blue-700">
                                      {extensionFeatures.some(f => selectedFeatures.includes(f.id) && f.price === 0)
                                        ? `${calculateTotal().totalFirstMonth.toLocaleString('vi-VN')} VNƒê + b√°o gi√° ri√™ng`
                                        : `${calculateTotal().totalFirstMonth.toLocaleString('vi-VN')} VNƒê`
                                      }
                                    </span>
                                  </div>
                                </>
                              )}
                              
                              {/* Hi·ªÉn th·ªã core features c√≥ m√¥ t·∫£ nhu c·∫ßu */}
                              {Object.keys(featureRequirements).some(key => 
                                getCoreFeatures().some(f => f.id === key) && featureRequirements[key]
                              ) && (
                                <div className="border-t border-blue-200 pt-2">
                                  <div className="font-medium mb-2">T√≠nh nƒÉng c·ªët l√µi c√≥ nhu c·∫ßu ƒë·∫∑c bi·ªát:</div>
                                  {getCoreFeatures()
                                    .filter(f => featureRequirements[f.id])
                                    .map(feature => (
                                      <div key={feature.id} className="mb-2">
                                        <div className="text-xs">
                                          <span>‚Ä¢ {feature.name}</span>
                                        </div>
                                        <div className="text-xs text-blue-600 mt-1 pl-2 border-l-2 border-blue-300">
                                          <strong>Nhu c·∫ßu:</strong> &quot;{featureRequirements[feature.id]}&quot;
                                        </div>
                                      </div>
                                    ))}
                                </div>
                              )}
                              
                              {/* Hi·ªÉn th·ªã t√≠nh nƒÉng kh√°c n·∫øu c√≥ */}
                              {otherFeatureRequirement && (
                                <div className="border-t border-blue-200 pt-2">
                                  <div className="font-medium mb-2">T√≠nh nƒÉng kh√°c:</div>
                                  <div className="text-xs text-purple-600 pl-2 border-l-2 border-purple-300">
                                    &quot;{otherFeatureRequirement}&quot;
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>

                          {/* Th√¥ng b√°o th√†nh c√¥ng - hi·ªÉn th·ªã thay th·∫ø form */}
                          {submitStatus === 'success' ? (
                            <div className="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4 text-center animate-in fade-in slide-in-from-bottom-4 duration-500 relative">
                              <button
                                onClick={() => {
                                  setSubmitStatus('idle');
                                  setLastSubmittedData(null);
                                }}
                                className="absolute top-2 right-2 text-green-600 hover:text-green-800 transition-colors"
                                title="ƒê√≥ng th√¥ng b√°o"
                              >
                                <svg className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                </svg>
                              </button>
                              <div className="flex items-center justify-center mb-3">
                                <div className="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center animate-bounce">
                                  <svg className="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                  </svg>
                                </div>
                              </div>
                              <h3 className="text-lg font-bold text-green-800 mb-2">
                                üéâ ƒêƒÉng k√Ω th√†nh c√¥ng!
                              </h3>
                              <p className="text-green-700 text-sm leading-relaxed mb-3">
                                C·∫£m ∆°n <strong>{lastSubmittedData?.name || 'b·∫°n'}</strong> ƒë√£ quan t√¢m ƒë·∫øn d·ªãch v·ª•!<br />
                                Ch√∫ng t√¥i ƒë√£ g·ª≠i th√¥ng tin chi ti·∫øt ƒë·∫øn email <strong>{lastSubmittedData?.email}</strong><br />
                                v√† s·∫Ω li√™n h·ªá qua s·ªë <strong>{lastSubmittedData?.phone}</strong> trong 24h t·ªõi.
                              </p>
                              <div className="bg-green-100 rounded-lg p-3 text-xs text-green-700">
                                üìß Email x√°c nh·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i v·ªõi th√¥ng tin:
                                <br />‚Ä¢ Chi ti·∫øt g√≥i {lastSubmittedData?.package}
                                <br />‚Ä¢ B√°o gi√° ch√≠nh x√°c: {calculateTotal().totalFirstMonth.toLocaleString('vi-VN')} VNƒê
                                <br />‚Ä¢ H∆∞·ªõng d·∫´n tri·ªÉn khai
                              </div>
                              <div className="mt-4 flex items-center justify-center space-x-2 text-xs text-green-600">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>Th√¥ng b√°o t·ª± ƒë·ªông ƒë√≥ng sau 15 gi√¢y</span>
                              </div>
                            </div>
                          ) : (
                            /* Form ƒëƒÉng k√Ω chi ti·∫øt */
                            <form onSubmit={handleSubmit} className="space-y-4">
                              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">
                                    H·ªç v√† t√™n <span className="text-red-500">*</span>
                                  </label>
                                  <input 
                                    type="text" 
                                    name="name"
                                    value={formData.name}
                                    onChange={handleInputChange}
                                    className="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" 
                                    placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n"
                                    required
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">
                                    S·ªë ƒëi·ªán tho·∫°i <span className="text-red-500">*</span>
                                  </label>
                                  <input 
                                    type="tel" 
                                    name="phone"
                                    value={formData.phone}
                                    onChange={handleInputChange}
                                    className="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" 
                                    placeholder="0987654321"
                                    pattern="^(0[235789])[0-9]{8}$"
                                    title="S·ªë ƒëi·ªán tho·∫°i 10 ch·ªØ s·ªë, b·∫Øt ƒë·∫ßu 02,03,05,07,08,09"
                                    required
                                  />
                                </div>
                              </div>
                              
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                  Email <span className="text-red-500">*</span>
                                </label>
                                <input 
                                  type="email" 
                                  name="email"
                                  value={formData.email}
                                  onChange={handleInputChange}
                                  className="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" 
                                  placeholder="email@company.com"
                                  required
                                />
                                <p className="text-xs text-gray-500 mt-1">
                                  üìß Th√¥ng tin chi ti·∫øt s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email n√†y
                                </p>
                              </div>
                              
                              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">
                                    G√≥i d·ªãch v·ª• quan t√¢m
                                  </label>
                                  <select 
                                    name="package"
                                    value={formData.package}
                                    onChange={handleInputChange}
                                    className="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                  >
                                    <option>Doanh Nghi·ªáp</option>
                                    <option>Doanh Nghi·ªáp Plus</option>
                                    <option>Enterprise</option>
                                  </select>
                                </div>
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">
                                    T√™n c√¥ng ty/t·ªï ch·ª©c
                                  </label>
                                  <input 
                                    type="text" 
                                    name="company"
                                    value={formData.company}
                                    onChange={handleInputChange}
                                    className="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" 
                                    placeholder="T√™n c√¥ng ty (t√πy ch·ªçn)"
                                  />
                                </div>
                              </div>
                              
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                  Nhu c·∫ßu c·ª• th·ªÉ (t√πy ch·ªçn)
                                </label>
                                <textarea 
                                  name="message"
                                  value={formData.message}
                                  onChange={handleInputChange}
                                  rows={3}
                                  className="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm resize-none" 
                                  placeholder="M√¥ t·∫£ chi ti·∫øt nhu c·∫ßu c·ªßa b·∫°n ƒë·ªÉ ch√∫ng t√¥i t∆∞ v·∫•n t·ªët h∆°n..."
                                ></textarea>
                                <p className="text-xs text-gray-500 mt-1">
                                  üí° Th√¥ng tin n√†y gi√∫p ch√∫ng t√¥i t∆∞ v·∫•n ch√≠nh x√°c h∆°n
                                </p>
                              </div>
                              
                              <button 
                                type="submit"
                                disabled={isSubmitting}
                                className="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 disabled:from-blue-400 disabled:to-blue-400 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 text-sm"
                              >
                                {isSubmitting ? (
                                  <span className="flex items-center justify-center">
                                    <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    ƒêang g·ª≠i th√¥ng tin...
                                  </span>
                                ) : (
                                  'üìß G·ª≠i th√¥ng tin & Nh·∫≠n b√°o gi√° qua Email'
                                )}
                              </button>

                              {/* Th√¥ng b√°o l·ªói */}
                              {submitStatus === 'error' && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                                  <div className="flex items-center justify-center mb-2">
                                    <svg className="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span className="text-red-800 font-medium">C√≥ l·ªói x·∫£y ra</span>
                                  </div>
                                  <p className="text-red-700 text-sm">
                                    {errorMessage || 'Vui l√≤ng th·ª≠ l·∫°i sau.'}
                                  </p>
                                </div>
                              )}
                            </form>
                          )}
                        </div>
                        
                        {/* Navigation Buttons */}
                        <div className="p-4 border-t border-gray-100 bg-gray-50">
                          <div className="flex justify-between items-center">
                            <button
                              onClick={() => setActiveTab('extension')}
                              className="flex items-center space-x-2 text-gray-600 hover:text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors font-medium"
                            >
                              <FaArrowLeft className="w-4 h-4" />
                              <span>Quay l·∫°i</span>
                            </button>
                            
                            <div className="text-sm text-gray-600">
                              B∆∞·ªõc 3/3: ƒêƒÉng k√Ω t∆∞ v·∫•n
                            </div>
                            
                            <div className="text-sm font-medium text-green-600">
                              ‚úì Ho√†n th√†nh
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* FAQ Section */}
                      <div className="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div className="p-4 border-b border-gray-100">
                          <h2 className="text-lg font-semibold text-gray-900">
                            ‚ùì C√¢u h·ªèi th∆∞·ªùng g·∫∑p
                          </h2>
                          <p className="text-sm text-gray-600 mt-1">
                            Nh·ªØng th·∫Øc m·∫Øc ph·ªï bi·∫øn v·ªÅ d·ªãch v·ª•
                          </p>
                        </div>
                        
                        <div className="divide-y divide-gray-100">
                          {faqs.map((faq, index) => (
                            <div key={index} className="p-4">
                              <button
                                onClick={() => toggleFaq(index)}
                                className="w-full text-left flex items-center justify-between hover:bg-gray-50 rounded-lg p-2 -m-2 transition-colors"
                              >
                                <span className="font-medium text-gray-900 text-sm pr-4">{faq.question}</span>
                                {openFaq === index ? (
                                  <FaChevronUp className="w-4 h-4 text-gray-500 flex-shrink-0" />
                                ) : (
                                  <FaChevronDown className="w-4 h-4 text-gray-500 flex-shrink-0" />
                                )}
                              </button>
                              
                              {openFaq === index && (
                                <div className="mt-3 pl-2 animate-in slide-in-from-top-2 duration-200">
                                  <p className="text-sm text-gray-600 leading-relaxed">{faq.answer}</p>
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}
                                                </>
                              )}
                              
                              {/* Hi·ªÉn th·ªã core features c√≥ m√¥ t·∫£ nhu c·∫ßu */}
                              {Object.keys(featureRequirements).some(key => 
                                getCoreFeatures().some(f => f.id === key) && featureRequirements[key]
                              ) && (
                                <div className="border-t border-blue-200 pt-2">
                                  <div className="font-medium mb-2">T√≠nh nƒÉng c·ªët l√µi c√≥ nhu c·∫ßu ƒë·∫∑c bi·ªát:</div>
                                  {getCoreFeatures()
                                    .filter(f => featureRequirements[f.id])
                                    .map(feature => (
                                      <div key={feature.id} className="mb-2">
                                        <div className="text-xs">
                                          <span>‚Ä¢ {feature.name}</span>
                                        </div>
                                        <div className="text-xs text-blue-600 mt-1 pl-2 border-l-2 border-blue-300">
                                          <strong>Nhu c·∫ßu:</strong> &quot;{featureRequirements[feature.id]}&quot;
                                        </div>
                                      </div>
                                    ))}
                                </div>
                              )}
                              
                              {/* Hi·ªÉn th·ªã t√≠nh nƒÉng kh√°c n·∫øu c√≥ */}
                              {otherFeatureRequirement && (
                                <div className="border-t border-blue-200 pt-2">
                                  <div className="font-medium mb-2">T√≠nh nƒÉng kh√°c:</div>
                                  <div className="text-xs text-purple-600 pl-2 border-l-2 border-purple-300">
                                    &quot;{otherFeatureRequirement}&quot;
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>

          {/* Sidebar - Pricing Only */}
          <div className="lg:w-80 space-y-6">
            {/* B·∫£ng t√≠nh ph√≠ */}
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 sticky top-24">
              <div className="p-4 border-b border-gray-100">
                <h2 className="text-lg font-semibold text-gray-900">
                  üí∞ T·ªïng chi ph√≠
                </h2>
                <p className="text-xs text-gray-600 mt-1">
                  Gi√° t·ª± ƒë·ªông c·∫≠p nh·∫≠t theo l·ª±a ch·ªçn
                </p>
              </div>
              
              <div className="p-4 space-y-3">
                <div className="flex justify-between text-sm">
                  <span>G√≥i c∆° b·∫£n:</span>
                  <span className="font-medium">{basePrice.toLocaleString('vi-VN')} VNƒê/th√°ng</span>
                </div>
                <div className="text-xs text-gray-500 -mt-1">
                  ‚úì Bao g·ªìm {coreFeaturesList.length} t√≠nh nƒÉng c·ªët l√µi
                </div>
                
                {selectedServices.filter(s => (s.price || 0) > 0).map((service) => (
                  <div key={service.id} className="flex justify-between text-sm">
                    <span className="truncate mr-2">{service.name}:</span>
                    <span className="font-medium">+{(service.price || 0).toLocaleString('vi-VN')} VNƒê</span>
                  </div>
                ))}
                
                <div className="border-t pt-3">
                  <div className="flex justify-between font-semibold">
                    <span>Ph√≠ h√†ng th√°ng:</span>
                    <span className="text-blue-600">{monthlyTotal.toLocaleString('vi-VN')} VNƒê</span>
                  </div>
                </div>
                
                <div className="flex justify-between text-sm text-gray-600">
                  <span>Ph√≠ thi·∫øt l·∫≠p (1 l·∫ßn):</span>
                  <span>{setupFee.toLocaleString('vi-VN')} VNƒê</span>
                </div>
                
                <div className="border-t pt-3">
                  <div className="flex justify-between text-lg font-bold text-green-600">
                    <span>T·ªïng th√°ng ƒë·∫ßu:</span>
                    <span>{totalFirstMonth.toLocaleString('vi-VN')} VNƒê</span>
                  </div>
                </div>

                {/* Thanh to√°n nƒÉm */}
                <div className="bg-blue-50 rounded-lg p-3 mt-4">
                  <h3 className="font-semibold text-blue-900 mb-2 text-sm">üí° Ti·∫øt ki·ªám 10% khi thanh to√°n nƒÉm</h3>
                  <div className="space-y-1 text-xs">
                    <div className="flex justify-between">
                      <span>Ph√≠ nƒÉm (12 th√°ng):</span>
                      <span className="font-medium">{annualTotal.toLocaleString('vi-VN')} VNƒê</span>
                    </div>
                    <div className="flex justify-between text-green-600">
                      <span>Ti·∫øt ki·ªám:</span>
                      <span className="font-bold">-{annualSavings.toLocaleString('vi-VN')} VNƒê</span>
                    </div>
                    <div className="flex justify-between font-bold text-blue-600">
                      <span>Thanh to√°n nƒÉm:</span>
                      <span>{(annualTotal - annualSavings).toLocaleString('vi-VN')} VNƒê</span>
                    </div>
                  </div>
                </div>

                {/* CTA Button */}
                <div className="pt-3 border-t">
                  <button
                    onClick={() => setActiveTab('consultation')}
                    className="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 text-sm"
                  >
                    üìû ƒêƒÉng k√Ω t∆∞ v·∫•n ngay
                  </button>
                  <p className="text-xs text-gray-500 text-center mt-2">
                    Nh·∫≠n b√°o gi√° ch√≠nh x√°c qua email
                  </p>
                </div>
              </div>
            </div>


          </div>
        </div>
      </div>
    </div>
  );
} 